---
date: 2016-05-11 24:00:00+00:00
layout: post
title: å¾®ä¿¡å¹³å°ä¹‹æ•°æ®æŸ¥è¯¢
categories: æ–‡æ¡£
tags: å¾®ä¿¡ æ•°æ® æŸ¥è¯¢ å¼€å‘
---
##åŠŸèƒ½éœ€æ±‚ï¼š
####å®ç°ä¸€ä¸ªå¦‚ä¸‹çš„æŸ¥è¯¢æ–¹æ³•ï¼Œåœ¨å¾®ä¿¡ä¸­ç›´æ¥å‘é€å…³é”®å­—æŸ¥è¯¢
![chaxun1](/img/blog/jc5-cx.png)
##<a name="index"/>æ¦‚è¦
* [é…ç½®configæ–‡ä»¶](#set)
* [ç”Ÿæˆæ•°æ®åº“æ–‡ä»¶](#load)
* [ç”ŸæˆæŸ¥è¯¢ä»£ç ](#wechat)

##<a name="set"/>é…ç½®configæ–‡ä»¶</a>
####å¤åˆ¶ä»¥ä¸‹ä»£ç ç”Ÿæˆconfig.phpæ–‡ä»¶ï¼Œä¿®æ”¹å…¶ä¸­çš„æ•°æ®åº“è´¦å·å¯†ç ä¿¡æ¯ï¼Œä¿®æ”¹ä½ çš„appidå’Œappsecret,å°†å®ƒä¿å­˜ä½ æœåŠ¡å™¨çš„æ ¹ç›®å½•

```
<?php
$conn = @mysql_connect("localhost","æ•°æ®åº“è´¦å·","æ•°æ®åº“å¯†ç ") or die ("æ•°æ®åº“è¿æ¥é”™è¯¯ï¼");//å¡«å†™ä½ çš„è´¦å·ï¼Œå¯†ç 
if(!$conn)
{
	die("mysql conn failed");
}
else{

	mysql_query("set names uft-8");
	mysql_select_db("æ•°æ®åº“åç§°",$conn);//å¡«å†™ä½ çš„æ•°æ®åº“åç§°
	if(!$conn)
	{
		die("database selected failed");
	}
}

define('appid','wx9...');//ä½ è‡ªå·±çš„appid
define('appsecret','e28...');//ä½ è‡ªå·±çš„appsecret
?>
```

#####å…¶ä¸­æ•°æ®åº“åç§°å¦‚ä¸‹ï¼Œç„¶åè´¦å·å¯†ç æ˜¯æˆ‘ä»¬åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»çš„ã€‚
![chaxun2](/img/blog/jc5-cx-sqlname.JPG)
##<a name="load"/>ç”Ÿæˆæ•°æ®åº“æ–‡ä»¶</a>
####ä¸‹é¢æˆ‘ä»¬å­¦ä¼šå°†æˆ‘ä»¬ç°æœ‰çš„xlsè¡¨æ ¼æ•°æ®å¯¼å…¥åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ä¸­ï¼Œå¯çœ‹ä»¥ä¸‹åŠ¨ç”»
![chaxun3](/img/blog/jc5-cx-xlstocsv.gif)

* åŸºæœ¬æ“ä½œæ˜¯
  1. å°†xls/xlsxå˜æˆcsvæ–‡ä»¶
  2. ä½¿ç”¨Notepad++æ‰“å¼€csvæ–‡ä»¶æ›´æ”¹ç¼–ç ä¸ºutf-8
  3. åœ¨æ•°æ®åº“ä¸­å¯¼å…¥csvæ–‡ä»¶
  4. æ›´æ”¹è¡¨åä¸ºåˆé€‚çš„åç§°æ¯”å¦‚æˆ‘çš„æ˜¯cx_score
    - ä¿å­˜åè®°å¾—å†æ¬¡æŸ¥çœ‹æ˜¯å¦æ›´æ”¹æˆåŠŸ
    - å¦‚æœä»æ—§çœ‹ä¸æ‡‚æˆ‘è¯´çš„ï¼Œå¯ä»¥å‚è€ƒ [mysqlå¯¼å…¥excelæ•°æ®](http://www.cnblogs.com/yuwensong/p/4026332.html)

##<a name="wechat"/>ç”ŸæˆæŸ¥è¯¢ä»£ç </a>
####æˆ‘ä»¬é¦–å…ˆå…ˆå»éªŒè¯ä¸Šè¿°æ“ä½œæ˜¯å¦æˆåŠŸ
* æ“ä½œæ˜¯
  ->1. æ–°å»ºä¸€ä¸ªcxtest.php,å†™å…¥ä»¥ä¸‹ä»£ç 

```
 <?php
 include("../config.php");
$sql="select * from cs_score";  //å¯ä»¥æŠŠcs_scoreæ”¹æˆä½ è‡ªå·±å–çš„åå­—
$query=mysql_query($sql);
echo '< pre>';
while($row=mysql_fetch_array($query))
{
print_r($row);
 }
?>
```


	->2.åœ¨ä½ æœåŠ¡å™¨æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹,å¦‚æˆ‘çš„æ˜¯shuju,å¦‚å›¾
![chaxun4](/img/blog/jc5-cx-file.JPG)
	->3. åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä½ çš„åŸŸå/shuju/cxtest.php,å¦‚æˆ‘çš„æ˜¯http://hi.wxhand.cn/shuju/cxtest.php,å¦‚å›¾æ‰€ç¤º
![chaxun5](/img/blog/jc5-cx-show.JPG)
	->4.å¦‚æœæœ‰é—®é¢˜è¯·æ£€æŸ¥æ˜¯å¦æ˜¯config.php,æ•°æ®åº“ä¿¡æ¯é‚£é‡Œæ˜¯å¦æ­£ç¡®ã€‚

####ä¸‹é¢æˆ‘ä»¬å»è®¾ç½®æŸ¥è¯¢ä»£ç 

```
<?php

//
// å“åº”ç”¨æˆ·æ¶ˆæ¯
// æŸ¥è¯¢ç³»ç»Ÿï¼šby åŠ©æ¢¦è€…
//

define("TOKEN", "weixin");                    //tokenè‡ªå·±æ”¹
include "../config.php";

$wechatObj = new wechatCallbackapiTest();
if (!isset($_GET['echostr'])) {
	$wechatObj->responseMsg();
}else{
    $wechatObj->valid();
}

class wechatCallbackapiTest
{
    public function valid()
    {
        $echoStr = $_GET["echostr"];
        if($this->checkSignature()){
            echo $echoStr;
            exit;
        }
    }

    private function checkSignature()
    {
        $signature = $_GET["signature"];
        $timestamp = $_GET["timestamp"];
        $nonce = $_GET["nonce"];
        $token = TOKEN;
        $tmpArr = array($token, $timestamp, $nonce);
        sort($tmpArr);
        $tmpStr = implode($tmpArr);
        $tmpStr = sha1($tmpStr);

        if($tmpStr == $signature){
            return true;
        }else{
            return false;
        }
    }

    public function responseMsg()
    {
        $postStr = $GLOBALS["HTTP_RAW_POST_DATA"];
        if (!empty($postStr)){
            $postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);
            $RX_TYPE = trim($postObj->MsgType);

            //ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ç±»å‹åˆ¤æ–­
            switch ($RX_TYPE)
            {
                case "text":
                    $result = $this->receiveText($postObj);
                    break;
                case "image":
                    $result = $this->receiveImage($postObj);
                    break;
                case "voice":
                    $result = $this->receiveVoice($postObj);
                    break;
                case "video":
                    $result = $this->receiveVideo($postObj);
                    break;
                default:
                    $result = "unknow msg type: ".$RX_TYPE;
                    break;
            }
            echo $result;
        }else {
            echo "";
            exit;
        }
    }
    
    private function receiveText($object)
    {
		$openid=$object->FromUserName;
		$keyword= $object->Content;
		//$key='åˆ†æ•°';    //è¿™é‡Œè®¾ç½®æŸ¥è¯¢æ–¹å¼çš„å…³é”®å­—ï¼Œå¦‚æˆ‘è®¾ç½®çš„æ˜¯ï¼šåˆ†æ•° 
		preg_match('/åˆ†æ•°(.*)/',$keyword, $match); 
		$cx = $match[1]; 

				$sql="select * from cs_score where name='{$cx}' ";  //è¿™é‡Œcx_scoreå¯ä»¥æ”¹æˆä½ è‡ªå·±çš„è¡¨åï¼Œnameæ”¹æˆä½ è¦è®¾ç½®çš„å­—æ®µå
				$result2 = mysql_query($sql);
				$row = mysql_fetch_assoc($result2);

				if(empty($row)){
				$content = array();
				$content[] = array("Title"=>"âš äº²ï¼Œæ²¡æœ‰æŸ¥åˆ°ç›¸å…³ä¿¡æ¯ï¼è¯·æ£€æŸ¥æ‰€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼ä¹Ÿæœ‰å¯èƒ½ä½ çš„ä¿¡æ¯ã€‚", 
										"Description"=>"", 
										"PicUrl"=>"", 
										"Url" =>"");
				$content[] = array("Title"=>"ã€æŸ¥è¯¢æ ¼å¼ã€‘\nåˆ†æ•°+å§“å,å¦‚ã€åˆ†æ•°å°æ˜ã€‘",   //æ˜¾ç¤ºçš„å†…å®¹å¯ä»¥ä¿®æ”¹
										"Description"=>"", 
										"PicUrl"=>"", 
										"Url" =>"");		
				$content[] = array("Title"=>"ğŸ‘‰ğŸ« æ¬¢è¿æ¨èç»™ä½ çš„å¥½å‹å“¦", 
										"Description"=>"", 
										"PicUrl"=>"", 
										"Url" =>"");			
				$result = $this->transmitNews($object, $content);
				
				}
				else{
				
				/*
				id		name	score
				*/
				$sql="select * from cs_score where name='{$cx}' ";
				$query=mysql_query($sql);
				$content = array();
				$content[] = array("Title"=>"ğŸ“äº²ï¼Œä½ æŸ¥è¯¢çš„ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼", 
										"Description"=>"", 
										"PicUrl"=>"", 
										"Url" =>"");
				while($row2=mysql_fetch_array($query)){
					
						$name=$row2['name']; //å§“å
						$score=$row2['score']; //å§“å
						/*
						$bj=$row2['bj']; //ç­çº§...ä½ ä»¬å¯ä»¥æŒ‰ç…§è¿™ä¸ªæ ¼å¼è‡ªå·±æ·»åŠ 
						*/
						
					$xs="ã€ä¿¡æ¯å¦‚ä¸‹ã€‘\nå§“åï¼š".$name."\nåˆ†æ•°ï¼š".$score;
					
					$content[] = array("Title"=>$xs,  
										"Description"=>"", 
										"PicUrl"=>"", 
										"Url" =>"");
				    }
					$content[] = array("Title"=>"ğŸ‘‰ğŸ«æ„Ÿè°¢ä½¿ç”¨",  //æ˜¾ç¤ºçš„å†…å®¹å¯ä»¥ä¿®æ”¹
										"Description"=>"", 
										"PicUrl"=>"", 
										"Url" =>"");
					$result = $this->transmitNews($object, $content);
					}
				return $result;
    }

    /*
     * å›å¤æ–‡æœ¬æ¶ˆæ¯
     */
    private function transmitText($object, $content)
    {
        $textTpl = "<xml>
<ToUserName><![CDATA[%s]]></ToUserName>
<FromUserName><![CDATA[%s]]></FromUserName>
<CreateTime>%s</CreateTime>
<MsgType><![CDATA[text]]></MsgType>
<Content><![CDATA[%s]]></Content>
</xml>";
        $result = sprintf($textTpl, $object->FromUserName, $object->ToUserName, time(), $content);
        return $result;
    }
    
    /*
     * å›å¤å›¾æ–‡æ¶ˆæ¯
     */
    private function transmitNews($object, $arr_item)
    {
        if(!is_array($arr_item))
            return;

        $itemTpl = "    <item>
        <Title><![CDATA[%s]]></Title>
        <Description><![CDATA[%s]]></Description>
        <PicUrl><![CDATA[%s]]></PicUrl>
        <Url><![CDATA[%s]]></Url>
    </item>
";
        $item_str = "";
        foreach ($arr_item as $item)
            $item_str .= sprintf($itemTpl, $item['Title'], $item['Description'], $item['PicUrl'], $item['Url']);

        $newsTpl = "<xml>
<ToUserName><![CDATA[%s]]></ToUserName>
<FromUserName><![CDATA[%s]]></FromUserName>
<CreateTime>%s</CreateTime>
<MsgType><![CDATA[news]]></MsgType>
<Content><![CDATA[]]></Content>
<ArticleCount>%s</ArticleCount>
<Articles>
$item_str</Articles>
</xml>";

        $result = sprintf($newsTpl, $object->FromUserName, $object->ToUserName, time(), count($arr_item));
        return $result;
    }

}
?>
```

####æœ€ç»ˆæ•ˆæœ
![chaxun5](/img/blog/jc5-cx-result.png)

___
>##å¦‚æœä»ç„¶æœ‰ç–‘é—®ï¼Œå¯åŠ ç¾¤è”ç³»
>![qqgroup](/img/blog/qqgroup.jpg)
___

